<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de la Oca – versión educativa (SVG + drag multijugador)</title>
<style>
  :root{ --bg:#DFF1FF; --ink:#23323f; --muted:#6b7a88; --brand:#26a69a; --accent:#ff69b4; --shadow:0 6px 18px rgba(0,0,0,.12); }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.3 ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial}
  h1{margin:.2rem 0 .6rem}
  button{cursor:pointer;border:0;border-radius:14px;padding:.8rem 1.1rem;background:var(--brand);color:#fff;box-shadow:var(--shadow)}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .opt{background:#fff;border-radius:12px;padding:8px 10px}
  .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#00000010}
  .small{font-size:.9rem;color:var(--muted)}

  #game{display:none;gap:16px;grid-template-columns:1fr 320px}
  #board{background:linear-gradient(180deg,#ECF8FF,#DBF1FF);border-radius:18px;position:relative;box-shadow:var(--shadow);overflow:hidden;aspect-ratio:1149/768;max-width:1149px;width:100%;margin:auto}
  #boardSvg{width:100%;height:100%;display:block;border-radius:18px}
  .pawn{position:absolute;left:0;top:0;width:48px;height:48px;image-rendering:auto;transform-origin:top left;z-index:20;margin:-10px}
  .hud{background:#fff;border-radius:18px;padding:12px;box-shadow:var(--shadow)}
  .log{height:240px;overflow:auto;background:#eef6ff;border-radius:12px;padding:10px}
  #testOut{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <header id="menu" class="card">
    <h1>Juego de la Oca – <span class="badge">SVG + drag</span></h1>
    <p class="small">Tablero SVG, peones con 4 poses (NE/NO/SE/SO). El jugador arrastra su peón a la losa iluminada. Multijugador soportado.</p>
    <div class="row">
      <label class="opt"><input type="radio" name="mode" value="solo" checked> 1 jugador</label>
      <label class="opt"><input type="radio" name="mode" value="multi"> Multijugador (2–4)</label>
    </div>
    <div id="playersSetup" class="row"></div>
    <div class="row">
      <button id="btnStart">Empezar partida</button>
      <button id="btnTests" style="background:#6b7a88">Ejecutar tests</button>
    </div>
    <details><summary>Salida de tests</summary><div id="testOut" class="card"></div></details>
  </header>

  <main id="game" class="grid">
    <section aria-label="Tablero">
      <div id="board">
        <svg id="boardSvg" viewBox="0 0 1149 768" preserveAspectRatio="xMidYMid meet"></svg>
      </div>
    </section>
    <aside id="side">
      <div class="hud">
        <h3>Turno</h3>
        <div id="turnInfo" class="small">—</div>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <div class="die" id="die" style="width:42px;height:42px;border-radius:10px;background:#fff;display:grid;place-items:center;box-shadow:var(--shadow);font-weight:800">—</div>
          <button id="btnRoll">Tirar dado</button>
        </div>
      </div>
      <div class="hud">
        <h3>Historial</h3>
        <div id="log" class="log"></div>
      </div>
    </aside>
  </main>
</div>

<script>
(function(){
  'use strict';

  // ===== Assets =====
  var TILE_SRC='assets/img/base.svg';
  var START_SRC='assets/img/start_pad.svg';
  var ISLAND_SRC={
    'isla-1':'assets/img/isla-1.svg','isla-2':'assets/img/isla-2.svg','isla-3':'assets/img/isla-3.svg',
    'isla-4':'assets/img/isla-4.svg','isla-5':'assets/img/isla-5.svg','isla-6':'assets/img/isla-6.svg'
  };
  // Sets por color: r=rojo, b=azul, g=verde, y=amarillo
  var PAWN_SETS={
    r:{ NE:'assets/img/pawns/maus-r-NE.svg', NO:'assets/img/pawns/maus-r-NO.svg', SE:'assets/img/pawns/maus-r-SE.svg', SO:'assets/img/pawns/maus-r-SO.svg' },
    b:{ NE:'assets/img/pawns/maus-b-NE.svg', NO:'assets/img/pawns/maus-b-NO.svg', SE:'assets/img/pawns/maus-b-SE.svg', SO:'assets/img/pawns/maus-b-SO.svg' },
    g:{ NE:'assets/img/pawns/maus-g-NE.svg', NO:'assets/img/pawns/maus-g-NO.svg', SE:'assets/img/pawns/maus-g-SE.svg', SO:'assets/img/pawns/maus-g-SO.svg' },
    y:{ NE:'assets/img/pawns/maus-y-NE.svg', NO:'assets/img/pawns/maus-y-NO.svg', SE:'assets/img/pawns/maus-y-SE.svg', SO:'assets/img/pawns/maus-y-SO.svg' }
  };

  // ===== Layout (top-left coords) =====
  var LAYOUT=[
    {id:'start_pad', kind:'start', x:58.28, y:647.09, w:184.51, h:102.64},
    {id:'L1', kind:'tile', x:184.11, y:633.18, w:87, h:48},
    {id:'L2', kind:'tile', x:234.32, y:607.37, w:87, h:48},
    {id:'isla-1', kind:'island', x:225.65, y:454.72, w:224.23, h:224.23},
    {id:'L3', kind:'tile', x:392.41, y:584.78, w:87, h:48},
    {id:'L4', kind:'tile', x:443.23, y:609.99, w:87, h:48},
    {id:'L5', kind:'tile', x:494.04, y:634.59, w:87, h:48},
    {id:'P12a', kind:'tile', x:544.86, y:659.80, w:87, h:48},
    {id:'L6', kind:'tile', x:595.67, y:634.19, w:87, h:48},
    {id:'L7', kind:'tile', x:645.88, y:608.38, w:87, h:48},
    {id:'L8', kind:'tile', x:696.50, y:582.57, w:87, h:48},
    {id:'L9', kind:'tile', x:747.72, y:556.96, w:87, h:48},
    {id:'isla-2', kind:'island', x:761.83, y:393.62, w:215.56, h:236.54},
    {id:'L10', kind:'tile', x:750.00, y:482.00, w:87, h:48},
    {id:'L11', kind:'tile', x:700.00, y:456.00, w:87, h:48},
    {id:'L12', kind:'tile', x:649.00, y:430.00, w:87, h:48},
    {id:'L13', kind:'tile', x:598.00, y:405.00, w:87, h:48},
    {id:'isla-3', kind:'island', x:461.17, y:258.92, w:206.69, h:206.69},
    {id:'L14', kind:'tile', x:432.94, y:397.65, w:87, h:48},
    {id:'P34a', kind:'tile', x:382.13, y:423.26, w:87, h:48},
    {id:'L15', kind:'tile', x:331.51, y:398.06, w:87, h:48},
    {id:'L16', kind:'tile', x:280.90, y:372.85, w:87, h:48},
    {id:'L17', kind:'tile', x:230.49, y:347.44, w:87, h:48},
    {id:'isla-4', kind:'island', x:83.48, y:238.55, w:201.65, h:200.04},
    {id:'L18', kind:'tile', x:229.28, y:272.03, w:87, h:48},
    {id:'L19', kind:'tile', x:280.50, y:246.42, w:87, h:48},
    {id:'L20', kind:'tile', x:331.51, y:220.81, w:87, h:48},
    {id:'isla-5', kind:'island', x:327.08, y:59.49, w:202.29, h:223.06},
    {id:'L21', kind:'tile', x:470.65, y:150.43, w:87, h:48},
    {id:'L22', kind:'tile', x:522.07, y:125.02, w:87, h:48},
    {id:'P56a', kind:'tile', x:572.28, y:99.21,  w:87, h:48},
    {id:'L23', kind:'tile', x:623.50, y:124.62, w:87, h:48},
    {id:'L24', kind:'tile', x:674.12, y:150.43, w:87, h:48},
    {id:'L25', kind:'tile', x:724.93, y:176.24, w:87, h:48},
    {id:'L26', kind:'tile', x:775.34, y:202.05, w:87, h:48},
    {id:'P56b', kind:'tile', x:827.77, y:227.26, w:87, h:48},
    {id:'L27', kind:'tile', x:878.59, y:201.45, w:87, h:48},
    {id:'isla-6', kind:'island', x:891.70, y:58.08,  w:203.26, h:203.26}
  ];

  var Z={
    'start_pad':1,
    'L1':2,'L2':3,'isla-1':0,'L3':3,'L4':0,'L5':0,'P12a':0,'L6':0,'L7':0,'L8':0,'L9':3,
    'isla-2':1,'L10':0,'L11':0,'L12':0,'L13':3,'isla-3':0,'L14':3,'P34a':3,'L15':3,
    'L16':3,'L17':3,'isla-4':2,'L18':0,'L19':0,'L20':3,'isla-5':2,
    'L21':0,'L22':0,'P56a':0,'L23':0,'L24':0,'L25':0,'L26':0,'P56b':0,'L27':3,
    'isla-6':0
  };

  // Orientación por índice del layout (no src directo)
  var ORI_BY_INDEX=[
    'NE','NE','NE','NE','SE','SE','SE','SE','NE','NE','NE','NE','NE','NO','NO','NO','NO',
    'NO','SO','SO','NO','NO','NO','NO','NE','NE','NE','NE','NE','NE','NE','SE','SE','SE','SE','SE','NE','NE'
  ];

  // ===== Posiciones EXACTAS (1 jugador) =====
  var PAWN_POS=[
    {x:140,y:660},{x:209,y:624},{x:259,y:598},{x:307,y:580},
    {x:422,y:574},{x:473,y:599},{x:524,y:623},{x:575,y:649},
    {x:621,y:625},{x:671,y:599},{x:722,y:574},{x:773,y:548},
    {x:815,y:528},{x:782,y:474},{x:732,y:448},{x:681,y:422},
    {x:630,y:397},{x:580,y:370},{x:460,y:386},{x:409,y:412},
    {x:361,y:388},{x:313,y:365},{x:262,y:339},{x:225,y:315},
    {x:254,y:263},{x:308,y:235},{x:357,y:212},{x:400,y:190},
    {x:496,y:141},{x:551,y:115},{x:597,y:90},{x:654,y:113},
    {x:704,y:139},{x:755,y:165},{x:805,y:191},{x:858,y:216},
    {x:904,y:192},{x:970,y:150}
  ];

  // ===== Posiciones EXACTAS (2 jugadores) =====
  // Cada entrada i: { j1:{x,y}, j2:{x,y} }
  var PAWN_POS_MULTI=[
    {j1:{x:130,y:650}, j2:{x:146,y:655}}, // start_pad 0
    {j1:{x:199,y:614}, j2:{x:225,y:629}}, // L1
    {j1:{x:249,y:588}, j2:{x:265,y:593}}, // L2
    {j1:{x:297,y:570}, j2:{x:313,y:575}}, // isla-1
    {j1:{x:432,y:564}, j2:{x:409,y:580}}, // L3
    {j1:{x:483,y:589}, j2:{x:470,y:595}}, // L4
    {j1:{x:534,y:613}, j2:{x:521,y:619}}, // L5
    {j1:{x:585,y:639}, j2:{x:572,y:645}}, // P12a
    {j1:{x:611,y:615}, j2:{x:627,y:620}}, // L6
    {j1:{x:661,y:589}, j2:{x:677,y:594}}, // L7
    {j1:{x:712,y:564}, j2:{x:728,y:569}}, // L8
    {j1:{x:763,y:538}, j2:{x:779,y:543}}, // L9
    {j1:{x:805,y:518}, j2:{x:821,y:523}}, // isla-2
    {j1:{x:769,y:480}, j2:{x:792,y:467}}, // L10
    {j1:{x:719,y:454}, j2:{x:729,y:447}}, // L11
    {j1:{x:668,y:428}, j2:{x:678,y:421}}, // L12
    {j1:{x:617,y:403}, j2:{x:627,y:396}}, // L13
    {j1:{x:567,y:376}, j2:{x:577,y:369}}, // isla-3
    {j1:{x:470,y:396}, j2:{x:450,y:385}}, // L14
    {j1:{x:419,y:422}, j2:{x:399,y:411}}, // P34a
    {j1:{x:348,y:394}, j2:{x:358,y:387}}, // L15
    {j1:{x:300,y:371}, j2:{x:310,y:364}}, // L16
    {j1:{x:249,y:345}, j2:{x:259,y:338}}, // L17
    {j1:{x:212,y:321}, j2:{x:222,y:314}}, // isla-4
    {j1:{x:244,y:253}, j2:{x:260,y:258}}, // L18
    {j1:{x:298,y:225}, j2:{x:314,y:230}}, // L19
    {j1:{x:347,y:202}, j2:{x:363,y:207}}, // L20
    {j1:{x:390,y:180}, j2:{x:406,y:185}}, // isla-5
    {j1:{x:486,y:131}, j2:{x:502,y:136}}, // L21
    {j1:{x:541,y:105}, j2:{x:557,y:110}}, // L22
    {j1:{x:587,y:80},  j2:{x:603,y:85}},  // P56a
    {j1:{x:664,y:103}, j2:{x:651,y:109}}, // L23
    {j1:{x:714,y:129}, j2:{x:701,y:135}}, // L24
    {j1:{x:765,y:155}, j2:{x:752,y:161}}, // L25
    {j1:{x:815,y:181}, j2:{x:802,y:187}}, // L26
    {j1:{x:868,y:206}, j2:{x:855,y:212}}, // P56b
    {j1:{x:894,y:182}, j2:{x:910,y:187}}, // L27
    {j1:{x:960,y:140}, j2:{x:976,y:145}}  // isla-6 (37)
  ];

  // ===== Estado =====
  var state=null; // {players:[{id,name,pos,set}], currentIdx, pending:{playerId, idx} }
  var overlayOn=false;

  // ===== Util =====
  function log(msg){ var el=document.getElementById('log'); if(!el) return; var d=document.createElement('div'); d.textContent=msg; el.appendChild(d); el.scrollTop=el.scrollHeight; }
  function updateTurnHUD(){ if(!state) return; var p=state.players[state.currentIdx]; document.getElementById('turnInfo').textContent = 'Turno: '+p.name; }

  // ===== SVG helpers =====
  function svgImage(href,x,y,w,h){var i=document.createElementNS('http://www.w3.org/2000/svg','image');i.setAttributeNS('http://www.w3.org/1999/xlink','href',href);i.setAttribute('x',x);i.setAttribute('y',y);i.setAttribute('width',w);i.setAttribute('height',h);return i;}
  function svgText(x,y,t){var e=document.createElementNS('http://www.w3.org/2000/svg','text');e.setAttribute('x',x);e.setAttribute('y',y);e.setAttribute('text-anchor','middle');e.setAttribute('dominant-baseline','middle');e.setAttribute('font-size','18');e.setAttribute('font-family','ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial');e.textContent=t;return e;}

  // ===== Render =====
  function renderBoard(){
    var svg=document.getElementById('boardSvg');
    svg.innerHTML='';
    // glow filter
    var defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
    var f=document.createElementNS('http://www.w3.org/2000/svg','filter');f.setAttribute('id','tileGlow');
    var g=document.createElementNS('http://www.w3.org/2000/svg','feGaussianBlur');g.setAttribute('stdDeviation','6');g.setAttribute('result','b');
    var m=document.createElementNS('http://www.w3.org/2000/svg','feMerge');var n1=document.createElementNS('http://www.w3.org/2000/svg','feMergeNode');n1.setAttribute('in','b');var n2=document.createElementNS('http://www.w3.org/2000/svg','feMergeNode');n2.setAttribute('in','SourceGraphic');m.appendChild(n1);m.appendChild(n2);f.appendChild(g);f.appendChild(m);defs.appendChild(f);svg.appendChild(defs);
    // draw ordered by z
    var draw=LAYOUT.map(function(it){var href=(it.kind==='start')?START_SRC:(it.kind==='tile')?TILE_SRC:ISLAND_SRC[it.id];return {id:it.id,x:it.x,y:it.y,w:it.w,h:it.h,z:Z[it.id]||0,href:href};});
    draw.sort(function(a,b){return a.z-b.z;});
    var grp=document.createElementNS('http://www.w3.org/2000/svg','g');svg.appendChild(grp);
    draw.forEach(function(it){grp.appendChild(svgImage(it.href,it.x,it.y,it.w,it.h));});
    drawOverlay(svg);
  }
  function drawOverlay(svg){var old=document.getElementById('overlay');if(old)old.remove();if(!overlayOn)return;var g=document.createElementNS('http://www.w3.org/2000/svg','g');g.id='overlay';svg.appendChild(g);LAYOUT.forEach(function(it,i){g.appendChild(svgText(it.x+it.w/2,it.y+it.h/2,String(i)));});}

  // ===== Coord helpers (coordenadas relativas a #board) =====
  function toScreenRect(x,y,w,h){
    const board = document.getElementById('board');
    const bw = board.clientWidth || board.getBoundingClientRect().width;
    const bh = board.clientHeight || board.getBoundingClientRect().height;
    const scale = Math.min(bw/1149, bh/768) || 1;
    const ox = (bw - 1149*scale)/2;
    const oy = (bh - 768*scale)/2;
    return { x: ox + x*scale, y: oy + y*scale, w: w*scale, h: h*scale, scale: scale };
  }

  // ===== Peón y drag =====
  function pawnSrcFor(player, idx){ var ori = ORI_BY_INDEX[idx] || 'NE'; var set = PAWN_SETS[player.set] || PAWN_SETS.r; return set[ori]; }

  function getPawnPos(idx, playerIndex){
    if(state && state.players && state.players.length===1 && PAWN_POS[idx]) return PAWN_POS[idx];
    if(state && state.players && state.players.length===2 && PAWN_POS_MULTI[idx]){
      return (playerIndex===1 ? PAWN_POS_MULTI[idx].j2 : PAWN_POS_MULTI[idx].j1);
    }
    // Fallback
    var it=LAYOUT[idx]; return {x: it.x + it.w/2 - 24, y: it.y + it.h/2 - 24};
  }

  function placePawn(p){
    var idx=Math.max(0,Math.min(PAWN_POS.length-1,p.pos|0));
    var pawnEl=document.getElementById('pawn-'+p.id);
    if(!pawnEl){
      pawnEl=document.createElement('img');
      pawnEl.className='pawn';
      pawnEl.id='pawn-'+p.id;
      pawnEl.setAttribute('draggable','false');
      pawnEl.setAttribute('alt','Peón '+p.name);
      document.getElementById('board').appendChild(pawnEl);
      enableDrag(pawnEl,p);
    }
    pawnEl.onerror=function(){ pawnEl.onerror=null; pawnEl.removeAttribute('src'); pawnEl.style.background='#3adb76'; };
    pawnEl.src = pawnSrcFor(p, idx);

    var playerIndex = (state && state.players) ? state.players.findIndex(pl=>pl.id===p.id) : 0;
    if(playerIndex<0) playerIndex=0;

    var pos=getPawnPos(idx, playerIndex);
    var scr=toScreenRect(pos.x,pos.y,0,0);
    var size=48*scr.scale; pawnEl.style.width=size+'px'; pawnEl.style.height=size+'px';
    pawnEl.style.transform='translate('+scr.x+'px,'+scr.y+'px)';
  }

  function setPendingDestination(player, destIdx){
    state.pending = { playerId: player.id, idx: destIdx };
    var old=document.getElementById('destGlow'); if(old) old.remove();
    var svg=document.getElementById('boardSvg'); var it=LAYOUT[destIdx];
    var r=document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('id','destGlow'); r.setAttribute('x',it.x); r.setAttribute('y',it.y); r.setAttribute('width',it.w); r.setAttribute('height',it.h);
    r.setAttribute('rx','8'); r.setAttribute('ry','8'); r.setAttribute('fill','rgba(255,255,255,0.001)'); r.setAttribute('stroke','#ff6fc0');
    r.setAttribute('stroke-width','3'); r.setAttribute('filter','url(#tileGlow)');
    svg.appendChild(r);
    document.getElementById('btnRoll').disabled = true;
  }
  function clearPending(){ state.pending=null; var g=document.getElementById('destGlow'); if(g) g.remove(); document.getElementById('btnRoll').disabled=false; }

  var dragging=false,startX=0,startY=0,origX=0,origY=0,dragEl=null;
  function enableDrag(el,p){
    el.addEventListener('pointerdown',function(ev){
      if(!state || state.players[state.currentIdx].id!==p.id) return;
      dragging=true; dragEl=el; startX=ev.clientX; startY=ev.clientY;
      var board=document.getElementById('board');
      var rb=board.getBoundingClientRect();
      var re=el.getBoundingClientRect();
      origX=re.left - rb.left; origY=re.top  - rb.top;
      ev.preventDefault();
    });
    window.addEventListener('pointermove',function(ev){
      if(!dragging) return; ev.preventDefault();
      var dx=ev.clientX-startX, dy=ev.clientY-startY;
      dragEl.style.transform='translate('+(origX+dx)+'px,'+(origY+dy)+'px)';
    });
    window.addEventListener('pointerup',function(ev){
      if(!dragging) return; dragging=false;

      if(!state || !state.pending || state.pending.playerId!==p.id){
        placePawn(p);
        return;
      }

      var idx=state.pending.idx;
      var board=document.getElementById('board'); var rb=board.getBoundingClientRect();
      var px=ev.clientX-rb.left, py=ev.clientY-rb.top;

      // 1) Validación contra la losa destino
      var tile=LAYOUT[idx];
      var rect=toScreenRect(tile.x,tile.y,tile.w,tile.h);
      var tolRect=Math.max(6,0.02*Math.max(rect.w,rect.h));
      var inTile=(px>=rect.x-tolRect && px<=rect.x+rect.w+tolRect && py>=rect.y-tolRect && py<=rect.y+rect.h+tolRect);

      // 2) Validación contra el punto exacto del peón (según jugador)
      var playerIndex=state.players.findIndex(pl=>pl.id===p.id); if(playerIndex<0) playerIndex=0;
      var pos=getPawnPos(idx,playerIndex);
      var sp=toScreenRect(pos.x,pos.y,0,0);
      var tolPoint=Math.max(18,28*sp.scale);
      var inPoint=(Math.abs(px-sp.x)<=tolPoint && Math.abs(py-sp.y)<=tolPoint);

      var ok=inTile || inPoint;

      if(ok){
        p.pos=idx; placePawn(p); clearPending();
        state.currentIdx=(state.currentIdx+1)%state.players.length; updateTurnHUD();
      } else {
        placePawn(p);
      }
    });
  }

  // ===== Dado → destino =====
  function roll(){
    var p=state.players[state.currentIdx]; var die=document.getElementById('die');
    var c=0; var t=setInterval(function(){ die.textContent=1+(c%6); c++; if(c>10){
      clearInterval(t);
      var n=1+Math.floor(Math.random()*6);
      die.textContent=n;
      var dest=Math.min(LAYOUT.length-1, p.pos+n);
      setPendingDestination(p,dest);
      log(p.name+' debe mover a casilla '+dest);
    } },70);
  }

  // ===== Tests =====
  function runTests(){
    var out=[]; function ok(n,c){ out.push((c?'✅':'❌')+' '+n); }
    renderBoard(); ok('Pinta sin errores', true);
    state={players:[{id:'1',name:'J1',pos:0,set:'r'}],currentIdx:0,pending:null}; placePawn(state.players[0]); ok('Peón inicial en start_pad', true);
    ok('LAYOUT length', LAYOUT.length===38);
    document.getElementById('testOut').textContent = out.join('\n');
  }

  // ===== Init =====
  (function init(){
    var playersSetup = document.getElementById('playersSetup');
    function drawSetup(mode){ playersSetup.innerHTML=''; var count=(mode==='solo')?1:2; for(var i=0;i<count;i++){ var b=document.createElement('span'); b.className='badge'; b.textContent='Jugador '+(i+1); playersSetup.appendChild(b);} }
    drawSetup('solo');
    document.querySelectorAll('input[name=mode]').forEach(function(r){ r.addEventListener('change', function(e){ drawSetup(e.target.value); }); });

    var btnStart=document.getElementById('btnStart'); var btnRoll=document.getElementById('btnRoll'); var btnTests=document.getElementById('btnTests');
    btnStart.onclick=function(){
      document.getElementById('menu').style.display='none';
      document.getElementById('game').style.display='grid';
      var mode=document.querySelector('input[name=mode]:checked').value; var count=(mode==='solo')?1:2;
      var sets=['r','g','b','y'];
      state={players:[], currentIdx:0, pending:null};
      for(var i=0;i<count;i++){ state.players.push({id:String(i+1), name:'J'+(i+1), pos:0, set:sets[i%sets.length]}); }
      renderBoard();
      state.players.forEach(placePawn);
      updateTurnHUD();
      if(window.ResizeObserver){ var ro=new ResizeObserver(function(){ state.players.forEach(placePawn); }); ro.observe(document.getElementById('board')); }
      else { window.addEventListener('resize', function(){ state.players.forEach(placePawn); }); }
    };
    btnRoll.onclick=roll; btnTests.onclick=runTests;
    document.addEventListener('keydown',function(e){ if((e.key||'').toLowerCase()==='o'){ overlayOn=!overlayOn; drawOverlay(document.getElementById('boardSvg')); }});
  })();
})();
</script>
</body>
</html>
